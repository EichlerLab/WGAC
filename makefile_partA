WGAC_GITHUB=/net/eichler/vol27/projects/assemblies/nobackups/macaque/wgac4/WGAC
FASTAWHOLE_DIR=fastawhole
REPEATMASKER_SPECIES=primates
# Evan (4/12/2019) said BLAST_SEED_SIZE should be 250--not 500
BLAST_SEED_SIZE=250
TRIM_SPECIES=primates
# This is the first step in the WGAC pipeline
# This makefile is for running the pipeline to prepare fugu2 for
# running on the Sun.  (DG, June 2017)
# see:  https://eichlerlab.gs.washington.edu/help/wiki/doku.php?id=methods:pipelines:wgac#defuguize_regions
#

# fastalength.log is needed for some things in makefile_partB
all : fugu2 data/bo_self.parse fastalength.log

fugu2 : fugu
	cp -r $^ $@
	fasta_only_ATCGN.pl -p $@ -o $@ -u

data/bo_self.parse : blastout
	perl ${WGAC_GITHUB}/rmNohitfiles.pl $^
	find $^ -type f -exec grep -L 'Matrix' {} \;
	# /usr/bin/perl must be used--not one of the perl modules
	export PATH=/usr/bin:$PATH
	blastparser42.pl -in ./blastout \
		-out data/bo_self.parse \
		-noprevq -v \
		-output '-ssort=>name, -hsort=>qb' \
		-filter '-min_bpalign=>$(BLAST_SEED_SIZE), -min_fracbpmatch=>0.88, -max_%gap =>40, -no_subject_self => yes, -no_doubleoverlap=>score'

blastout : blastdb/bofugu.nsq
	mkdir -p blastout
	qsub -pe orte 50 -N wgac_blast_$(TRIM_SPECIES) -q eichler-short.q -l h_rt=8:00:00 -sync y ${WGAC_GITHUB}/blast64.sh -t /var/tmp/$(shell whoami)/$(TRIM_SPECIES)/blastdb

blastdb/bofugu.nsq : fugu
	mkdir -p blastdb
	dir_cat $^ blastdb/bofugu
	formatdb -i blastdb/bofugu -o F -p F -a F
	rm -f blastdb/bofugu

fugu : fasta mask_out
	mkdir -p $@
	fasta_fuguize_batch.pl -f $< -r $(lastword $^) -o $@


mask_out : fasta
	mkdir -p $@
	ls $< |xargs -i perl ${WGAC_GITHUB}/maskOutGenFromLowCase.pl $</{} $@/{}.out
	mkdir -p data

fasta : fastawholesplit
	mkdir -p $@
	fasta_fractionate -f $^ -s 400000 -o $@


fastawholesplit : fastawhole
	mkdir -p $@
	cat fastawhole/* | ~/bin/split_fasta_file.py stdin -d fastawholesplit
	cd fastawholesplit && rename ".fasta" "" *

fastalength.log : fastawhole
	fasta_length -d $^/ -o $@ -f
